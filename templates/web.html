<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Bible AI</title>
    <style>
        :root {
            --font-scale: 1;
            --compact-padding: 20px;
            --compact-gap: 15px;
            --glass-bg: rgba(20, 20, 25, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --primary: #0A84FF;
            --primary-glow: rgba(10, 132, 255, 0.4);
            --secondary: #BF5AF2;
            --success: #30D158;
            --warning: #FF9F0A;
            --danger: #FF375F;
            --bg: #0a0a0f;
            --surface: rgba(30, 30, 35, 0.8);
            --text: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --font-size: 1rem;
            --animation-speed: 1;
        }

        [data-theme="light"] {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.9);
            --bg: #f5f5f7;
            --surface: rgba(255, 255, 255, 0.9);
            --text: #1a1a1a;
            --text-secondary: rgba(0, 0, 0, 0.6);
            --text-tertiary: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        html {
            font-size: var(--font-size);
        }
        
        body {
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Animated Background */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .ambient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.3;
            animation: float 20s infinite ease-in-out;
        }

        .orb-1 { width: 600px; height: 600px; background: var(--primary); top: -300px; right: -200px; }
        .orb-2 { width: 500px; height: 500px; background: var(--secondary); bottom: -200px; left: -100px; animation-delay: -7s; }
        .orb-3 { width: 400px; height: 400px; background: var(--success); top: 40%; left: 60%; animation-delay: -14s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }

        /* ===== COMPACT MODE ===== */
        body.compact-mode .verse-card { padding: 15px !important; }
        body.compact-mode .card { padding: 12px !important; }
        body.compact-mode .tab-view { padding: 15px !important; }
        body.compact-mode .library-grid { gap: 10px !important; }
        body.compact-mode .comment { padding: 10px !important; margin-bottom: 8px !important; }
        body.compact-mode .action-btn { padding: 8px 12px !important; }
        body.compact-mode .nav-item { padding: 8px 12px !important; }

        /* ===== NO ANIMATIONS ===== */
        body.no-animations * { 
            animation-play-state: paused !important; 
        }
        body.no-animations .ambient-orb { 
            opacity: 0.1 !important;
            animation: none !important;
        }
        body.no-animations .card,
        body.no-animations .btn,
        body.no-animations .tab-btn {
            transition: none !important;
        }

        /* ===== PARTICLES ===== */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        body.particles-on .particles {
            opacity: 1;
        }
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            animation: particleFloat 20s infinite linear;
        }
        @keyframes particleFloat {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            5% { opacity: 0.4; }
            95% { opacity: 0.4; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* ===== HIGH CONTRAST ===== */
        body.high-contrast {
            --primary: #0066FF;
            --primary-glow: rgba(0, 102, 255, 0.6);
            --text: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --glass-bg: rgba(0, 0, 0, 0.9);
        }
        body.high-contrast .card {
            border: 2px solid rgba(255,255,255,0.3);
        }
        body.high-contrast .verse-text {
            font-weight: 500;
        }

        /* App Container */
        .app {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
        }

        @media (min-width: 1024px) {
            .app {
                flex-direction: row;
                max-width: 1600px;
                margin: 0 auto;
                width: 100%;
                padding: 20px;
                gap: 20px;
            }
        }

        /* Header / Sidebar */
        .header {
            padding: calc(var(--safe-top) + 16px) 20px 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        @media (min-width: 1024px) {
            .header {
                width: 260px;
                flex-direction: column;
                align-items: stretch;
                border-bottom: none;
                border-right: 1px solid var(--glass-border);
                border-radius: 20px;
                height: calc(100vh - 40px);
                position: sticky;
                top: 20px;
                padding: 24px;
            }
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .brand:active {
            transform: scale(0.95);
        }

        @media (min-width: 1024px) {
            .brand {
                margin-bottom: 32px;
                justify-content: center;
                flex-direction: column;
                text-align: center;
                padding-top: 16px;
            }
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 20px var(--primary-glow);
            flex-shrink: 0;
            position: relative;
        }

        .admin-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .admin-badge.show {
            display: block;
        }
        
        .role-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .role-badge.show {
            display: block;
        }
        
        .role-user { background: #666; }
        .role-host { background: #30D158; }
        .role-mod { background: #FF9F0A; }
        .role-co_owner { background: #BF5AF2; }
        .role-owner { background: #FF375F; }

        @media (min-width: 1024px) {
            .brand-icon {
                width: 60px;
                height: 60px;
                font-size: 32px;
                border-radius: 18px;
            }
        }

        .brand-text {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        @media (min-width: 1024px) {
            .brand-text {
                font-size: 24px;
            }
        }

        .desktop-nav {
            display: none;
        }

        @media (min-width: 1024px) {
            .desktop-nav {
                display: flex;
                flex-direction: column;
                gap: 6px;
                flex: 1;
                overflow-y: auto;
            }
            
            .nav-item {
                padding: 14px 16px;
                background: transparent;
                border: 1px solid transparent;
                border-radius: 14px;
                color: var(--text-secondary);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 15px;
                font-weight: 600;
                transition: all 0.25s;
                text-align: left;
            }
            
            .nav-item:hover {
                background: var(--surface);
                color: var(--text);
            }
            
            .nav-item.active {
                background: var(--primary);
                color: white;
                box-shadow: 0 4px 15px var(--primary-glow);
            }
            
            .nav-icon {
                font-size: 20px;
            }
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        @media (min-width: 1024px) {
            .header-actions {
                margin-top: auto;
                justify-content: center;
                padding-top: 16px;
                border-top: 1px solid var(--glass-border);
            }
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 18px;
            color: var(--text);
            flex-shrink: 0;
        }

        .icon-btn:hover {
            transform: scale(1.08);
            background: var(--primary);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 16px;
            padding-bottom: calc(90px + var(--safe-bottom));
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
            .content {
                padding: 0;
                padding-bottom: 20px;
                display: grid;
                grid-template-columns: 1fr 380px;
                grid-template-rows: auto 1fr;
                gap: 20px;
                align-content: start;
                height: calc(100vh - 40px);
                overflow: hidden;
            }
        }

        @media (min-width: 1400px) {
            .content {
                grid-template-columns: 1fr 420px;
            }
        }

        /* Tab Views */
        .tab-view {
            display: none;
            animation: fadeIn calc(0.25s * var(--animation-speed)) ease-out;
            max-width: 100%;
        }

        .tab-view.active {
            display: block;
        }

        @media (min-width: 1024px) {
            .tab-view {
                display: none !important;
            }
            
            .tab-view.desktop-active {
                display: block !important;
                overflow-y: auto;
                max-height: 100%;
                padding-right: 8px;
            }
            
            #discover {
                grid-column: 1;
                grid-row: 1 / span 2;
            }
            
            #recommendations, #library, #comments {
                grid-column: 2;
                grid-row: span 1;
            }

            #profile {
                grid-column: 1 / span 2;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            transition: transform 0.25s, box-shadow 0.25s;
        }

        .glass-card:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        @media (min-width: 1024px) {
            .glass-card {
                margin-bottom: 0;
            }
        }

        /* Verse Display */
        .verse-container {
            cursor: pointer;
            transition: transform 0.25s;
        }

        .verse-container:hover {
            transform: scale(1.01);
        }

        .verse-text {
            font-size: 22px;
            line-height: 1.6;
            font-weight: 400;
            letter-spacing: -0.01em;
            margin-bottom: 20px;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .verse-text {
                font-size: 26px;
            }
        }

        @media (min-width: 1024px) {
            .verse-text {
                font-size: 28px;
                line-height: 1.5;
            }
        }

        .verse-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .verse-ref {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        .verse-source-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .verse-badge {
            background: linear-gradient(135deg, var(--warning), #FF6B35);
            color: white;
            padding: 5px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .signed-by {
            font-size: 10px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .action-grid {
                gap: 12px;
            }
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
        }

        .action-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--primary-glow);
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        .action-icon {
            font-size: 22px;
        }

        /* Timer */
        .timer-wrapper {
            margin-top: 20px;
        }

        .timer-bar {
            height: 4px;
            background: var(--surface);
            border-radius: 2px;
            overflow: hidden;
        }

        .timer-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: width 1s linear;
            box-shadow: 0 0 12px var(--primary-glow);
        }

        .timer-text {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Recommendations */
        .gen-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px var(--primary-glow);
            transition: all 0.25s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .gen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px var(--primary-glow);
        }

        .rec-card {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.08), rgba(191, 90, 242, 0.08));
            border: 1px solid rgba(10, 132, 255, 0.25);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            animation: slideIn 0.35s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Library Tab - Simplified */
        .favorites-collection {
            background: linear-gradient(135deg, rgba(255, 59, 95, 0.1), rgba(255, 159, 10, 0.1));
            border: 2px dashed var(--danger);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            min-height: 200px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .favorites-collection.drag-over {
            background: linear-gradient(135deg, rgba(255, 59, 95, 0.2), rgba(255, 159, 10, 0.2));
            transform: scale(1.02);
            border-color: var(--success);
        }

        .favorites-header {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .favorites-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .favorites-count {
            font-size: 32px;
            font-weight: 700;
            color: var(--danger);
            margin-top: 10px;
        }

        /* Verse List */
        .verse-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .verse-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            user-select: none;
            touch-action: manipulation;
        }

        .verse-card:hover {
            transform: translateX(4px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .verse-card.dragging {
            opacity: 0.6;
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .verse-card-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            pointer-events: none;
        }

        .verse-card-ref {
            font-size: 12px;
            color: var(--primary);
            font-weight: 700;
            pointer-events: none;
        }

        .verse-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--glass-border);
        }

        .verse-card-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .verse-card-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .verse-card-btn.liked {
            background: var(--danger);
            border-color: var(--danger);
        }

        .verse-card-btn.saved {
            background: var(--warning);
            border-color: var(--warning);
        }

        /* Comments Tab */
        .comments-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comment-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--glass-border);
        }

        .comment-section-header {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .comment-input-area {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            border: 1px solid var(--glass-border);
        }

        .comment-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 15px;
            resize: none;
            outline: none;
            min-height: 22px;
            max-height: 120px;
            font-family: inherit;
            line-height: 1.5;
        }

        .comment-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            font-size: 18px;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .comments-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .comment-item {
            background: var(--glass-bg);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--glass-border);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--glass-border);
        }

        .comment-meta {
            flex: 1;
        }

        .comment-name {
            font-size: 13px;
            font-weight: 700;
        }

        .comment-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
            margin-left: 42px;
            word-wrap: break-word;
        }

        .delete-comment-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--danger);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .delete-comment-btn.show {
            display: flex;
        }

        .delete-comment-btn:hover {
            transform: scale(1.1);
        }

        /* Community Chat Special Styling */
        .community-section {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.05), rgba(191, 90, 242, 0.05));
            border-color: rgba(10, 132, 255, 0.2);
        }

        .community-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Settings Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            animation: zoomIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .close-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            font-size: 16px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--danger);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--glass-border);
            flex-wrap: wrap;
            gap: 12px;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 16px;
            font-weight: 600;
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .toggle {
            width: 50px;
            height: 30px;
            background: var(--surface);
            border-radius: 30px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        .toggle.active {
            background: var(--success);
        }

        .toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.active .toggle-thumb {
            transform: translateX(20px);
        }

        .segment-control {
            display: flex;
            background: var(--surface);
            border-radius: 10px;
            padding: 2px;
            gap: 2px;
        }

        .segment-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .segment-btn.active {
            background: var(--glass-bg);
            color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .setting-select {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px 12px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            min-width: 120px;
        }

        .admin-only {
            display: none;
        }

        .admin-only.show {
            display: flex;
        }

        .admin-panel-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--danger), #FF6B35);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            display:
        }

        .admin-panel-btn.show {
            display: block;
        }

        /* Admin Unlock Modal */
        .admin-unlock-modal .modal-content {
            max-width: 420px;
            text-align: center;
        }

        .role-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .role-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 10px;
            background: var(--surface);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn:hover {
            border-color: var(--primary);
            background: rgba(10, 132, 255, 0.1);
        }

        .role-btn.selected {
            border-color: var(--primary);
            background: rgba(10, 132, 255, 0.15);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.3);
        }

        .role-btn.selected .role-name {
            color: var(--primary);
            font-weight: 700;
        }

        .role-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .role-name {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-code-input {
            width: 100%;
            padding: 16px;
            background: var(--surface);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            font-size: 18px;
            text-align: center;
            margin: 16px 0;
            letter-spacing: 2px;
        }

        .admin-code-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .unlock-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
        }

        .unlock-btn:disabled {
            background: var(--surface);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .unlock-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--primary-glow);
        }

        /* Mobile Tab Bar - Removed Images */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 10px 8px calc(10px + var(--safe-bottom));
            z-index: 100;
        }

        @media (min-width: 1024px) {
            .tab-bar {
                display: none;
            }
        }

        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 6px 2px;
            transition: all 0.25s;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-icon {
            font-size: 20px;
            transition: transform 0.25s;
        }

        .tab-btn.active .tab-icon {
            transform: translateY(-2px);
        }

        .tab-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Fullscreen Verse */
        .fullscreen-verse {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            cursor: pointer;
        }

        .fullscreen-verse.active {
            display: flex;
            animation: zoomIn 0.3s ease-out;
        }

        .fullscreen-text {
            font-size: clamp(22px, 4vw, 44px);
            line-height: 1.6;
            text-align: center;
            font-weight: 300;
            max-width: 900px;
            white-space: pre-wrap;
            margin-bottom: 40px;
        }

        .fullscreen-actions {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }

        .fullscreen-btn {
            padding: 14px 28px;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: var(--text);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-btn:hover {
            background: var(--primary);
            transform: scale(1.05);
        }

        .fullscreen-hint {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            padding: 14px 28px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10001;
            opacity: 0;
            transition: all 0.35s;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Profile Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: transform 0.25s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.7;
        }

        /* Profile Info Cards */
        .profile-info-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .profile-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .profile-info-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .profile-info-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .profile-info-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Profile Add-ons */
        .streak-day {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
        }
        .streak-day.active {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }
        .streak-day.inactive {
            background: var(--surface);
            opacity: 0.4;
        }
        .streak-day.today {
            border: 2px solid #ff6b35;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .achievement-badge {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: all 0.3s;
            position: relative;
        }
        .achievement-badge.unlocked {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid var(--primary);
            cursor: pointer;
        }
        .achievement-badge.locked {
            background: var(--surface);
            opacity: 0.4;
            filter: grayscale(1);
        }
        .achievement-badge:hover.unlocked {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        .achievement-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }
        .achievement-name {
            font-size: 9px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
        }
        .achievement-tooltip {
            position: fixed;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .achievement-tooltip.visible {
            opacity: 1;
        }

        .book-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .book-name {
            font-size: 13px;
            font-weight: 600;
            min-width: 100px;
            text-transform: uppercase;
        }
        .book-progress {
            flex: 1;
            height: 24px;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .book-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            font-weight: 700;
        }
        .book-count {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            min-width: 30px;
            text-align: right;
        }

        .verse-history-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px 16px;
            border-left: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .verse-history-ref {
            font-weight: 700;
            font-size: 13px;
            color: var(--primary);
        }
        .verse-history-time {
            font-size: 11px;
            opacity: 0.6;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 15px;
        }

        /* Loading Animation */
        .skeleton {
            background: linear-gradient(90deg, var(--surface) 25%, var(--glass-bg) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .comment-input::-webkit-scrollbar {
         display: none;
          }

        /* Utility */
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="ambient-bg">
        <div class="ambient-orb orb-1"></div>
        <div class="ambient-orb orb-2"></div>
        <div class="ambient-orb orb-3"></div>
    </div>
    
    <div class="particles"></div>

    <div class="app">
        <header class="header">
            <div class="brand" onclick="handleBrandClick()">
                <div class="brand-icon">
                    &#128214;
                    <span class="admin-badge" id="adminBadge">ADMIN</span>
                    <span class="role-badge" id="roleBadge"></span>
                </div>
                <div class="brand-text">Bible AI</div>
            </div>
            
            <nav class="desktop-nav">
                <button class="nav-item active" onclick="switchTab('discover')" data-tab="discover">
                    <span class="nav-icon">&#10024;</span>
                    <span>Discover</span>
                </button>
                <button class="nav-item" onclick="switchTab('recommendations')" data-tab="recommendations">
                    <span class="nav-icon">&#127919;</span>
                    <span>For You</span>
                </button>
                <button class="nav-item" onclick="switchTab('library')" data-tab="library">
                    <span class="nav-icon">&#128218;</span>
                    <span>Library</span>
                </button>
                <button class="nav-item" onclick="switchTab('comments')" data-tab="comments">
                    <span class="nav-icon">&#128172;</span>
                    <span>Comments</span>
                </button>
                <button class="nav-item" onclick="switchTab('profile')" data-tab="profile">
                    <span class="nav-icon">&#128100;</span>
                    <span>Profile</span>
                </button>
            </nav>

            <!-- Lovewell Church Credit -->
            <div style="margin-top: auto; padding: 15px; text-align: center; border-top: 1px solid var(--glass-border);">
                <!-- INSTRUCTIONS: Convert lovewell.png to base64:
                     1. Go to https://www.base64-image.de/ or similar
                     2. Upload your lovewell.png
                     3. Copy the base64 string (starts with data:image/png;base64,...)
                     4. Replace the src below with your base64 string -->
                <img src="data:image/jpeg;base64,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" 
                     alt="Lovewell Church" 
                     style="width: 40px; height: 40px; border-radius: 50%; margin-bottom: 5px; object-fit: cover;"
                     id="lovewellLogo">
                <div style="font-size: 10px; color: var(--text-tertiary);">Credit To Cross Community Lovewell</div>
            </div>

            <div class="header-actions">
                <button class="icon-btn" onclick="openSettings()" title="Settings">&#9881;</button>
                <button class="icon-btn" onclick="toggleFullscreen()" title="Fullscreen">&#9974;</button>
                <button class="icon-btn" onclick="showUser()" title="Profile">
                    <img src="{{ user.picture }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.src='https://ui-avatars.com/api/?name={{ user.name }}&background=0a84ff&color=fff'">
                </button>
            </div>
        </header>

        <main class="content">
            <!-- DISCOVER TAB -->
            <div id="discover" class="tab-view active desktop-active">
                <div class="glass-card verse-container" onclick="toggleFullscreen()">
                    <div class="verse-text" id="verseText">
                        <div class="skeleton" style="height: 32px; margin-bottom: 12px; width: 100%;"></div>
                        <div class="skeleton" style="height: 32px; margin-bottom: 12px; width: 90%;"></div>
                        <div class="skeleton" style="height: 32px; width: 70%;"></div>
                    </div>
                    <div class="verse-meta">
                        <div class="verse-ref" id="verseRef">Loading...</div>
                        <div class="verse-source-wrapper">
                            <span class="signed-by">-Signed By George-</span>
                            <span class="verse-badge" id="verseSource">...</span>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="action-grid">
                        <button class="action-btn" onclick="toggleLike()">
                            <span class="action-icon" id="likeIcon">&#9825;</span>
                            <span>Like</span>
                        </button>
                        <button class="action-btn" onclick="toggleSave()">
                            <span class="action-icon" id="saveIcon">&#128278;</span>
                            <span>Save</span>
                        </button>
                        <button class="action-btn" onclick="copyVerse()">
                            <span class="action-icon">&#128203;</span>
                            <span>Copy</span>
                        </button>
                        <button class="action-btn" onclick="shareVerse()">
                            <span class="action-icon">&#128228;</span>
                            <span>Share</span>
                        </button>
                    </div>

                    <div class="timer-wrapper">
                        <div class="timer-bar">
                            <div class="timer-progress" id="timerBar" style="width: 100%"></div>
                        </div>
                        <div class="timer-text">
                            <span>Next Verse</span>
                            <span id="timerText">60s</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RECOMMENDATIONS TAB -->
            <div id="recommendations" class="tab-view">
                <div class="glass-card">
                    <button class="gen-btn" onclick="generateRec()">
                        <span>&#128276;</span>
                        <span>Generate Recommendation</span>
                    </button>
                    
                    <div id="recList"></div>
                </div>
            </div>

            <!-- LIBRARY TAB - Simplified -->
            <div id="library" class="tab-view">
                <!-- Favorites Drop Zone -->
                <div class="favorites-collection" id="favoritesDropZone"
                     ondragover="handleDragOver(event)" 
                     ondrop="handleDrop(event)"
                     ondragleave="handleDragLeave(event)">
                    <div class="favorites-header">&#128150; Favorites</div>
                    <div class="favorites-text">Drag verses here to add to favorites</div>
                    <div class="favorites-count" id="favoritesCount">0</div>
                    <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 5px;">verses</div>
                </div>

                <!-- All Verses List -->
                <div class="glass-card">
                    <div class="library-header" style="margin-bottom: 12px;">
                        <span>&#128218;</span>
                        <span>My Verses (Drag to Favorites)</span>
                    </div>
                    
                    <div class="verse-list" id="libraryVersesList">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#9825;</div>
                            <div class="empty-state-text">No verses yet. Start liking and saving!</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMMENTS TAB -->
            <div id="comments" class="tab-view">
                <div class="comments-container">
                    <!-- Current Verse Comments -->
                    <div class="comment-section">
                        <div class="comment-section-header">
                            <span>&#128172;</span>
                            <span>Comments on <span id="commentVerseRef" style="color: var(--primary);">Current Verse</span></span>
                        </div>
                        
                        <div class="comment-input-area">
                            <textarea class="comment-input" id="commentInput" placeholder="Share your thoughts on this verse..." rows="1"></textarea>
                            <button class="send-btn" onclick="postComment()">&#8593;</button>
                        </div>

                        <div class="comments-list" id="commentsList"></div>
                    </div>

                    <!-- Community Chat -->
                    <div class="comment-section community-section">
                        <div class="comment-section-header">
                            <span>&#127757;</span>
                            <span>Community Chat</span>
                            <span class="community-badge">Life & Support</span>
                        </div>
                        
                        <div class="comment-input-area">
                            <textarea class="comment-input" id="communityInput" placeholder="Share about life, ask for help, or offer guidance..." rows="1"></textarea>
                            <button class="send-btn" onclick="postCommunityMessage()">&#8593;</button>
                        </div>

                        <div class="comments-list" id="communityList"></div>
                    </div>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile" class="tab-view">
                <div class="glass-card" style="text-align: center; padding: 32px;">
                    <img src="{{ user.picture }}" style="width: 90px; height: 90px; border-radius: 50%; margin-bottom: 16px; border: 3px solid var(--primary); box-shadow: 0 8px 24px var(--primary-glow);">
                    <div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">{{ user.name }}</div>
                    <div style="font-size: 14px; opacity: 0.6;">{{ user.email }}</div>
                    <div id="roleTag" style="display: none; margin-top: 8px; font-weight: 700; font-size: 14px; text-transform: uppercase;"></div>
                </div>

                <!-- Usage Stats -->
                <div class="profile-info-grid">
                    <div class="profile-info-card">
                        <div class="profile-info-label">Member Since</div>
                        <div class="profile-info-value" id="memberSince">Loading...</div>
                    </div>
                    <div class="profile-info-card">
                        <div class="profile-info-label">Time on Site</div>
                        <div class="profile-info-value" id="timeOnSite" style="color: var(--success);">0m 0s</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statVerses" style="color: var(--primary);">0</div>
                        <div class="stat-label">Verses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statLiked" style="color: var(--danger);">0</div>
                        <div class="stat-label">Liked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSaved" style="color: var(--warning);">0</div>
                        <div class="stat-label">Saved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statComments" style="color: var(--success);">0</div>
                        <div class="stat-label">Comments</div>
                    </div>
                </div>

                <!-- 1. READING STREAK -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="font-size: 18px; font-weight: 700;"> Reading Streak</div>
                        <div id="streakBadge" style="background: linear-gradient(135deg, #ff6b35, #f7931e); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;">0 DAYS</div>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;" id="streakCalendar">
                        <!-- Generated by JS -->
                    </div>
                    <div style="text-align: center; margin-top: 12px; font-size: 13px; opacity: 0.7;" id="streakMessage">
                        Start your streak today!
                    </div>
                </div>

                <!-- 2. ACHIEVEMENT BADGES -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;"> Achievements</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 12px;" id="achievementGrid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- 3. FAVORITE BOOKS CHART -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;"> Favorite Books</div>
                    <div id="favoriteBooksChart" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- 4. TODAY'S VERSE HISTORY -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;"> Today's Verses</div>
                    <div id="verseHistory" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <button class="gen-btn" style="background: var(--danger);" onclick="logout()">
                    Log Out
                </button>
            </div>
        </main>

        <!-- Mobile Tab Bar - No Images -->
        <nav class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('discover', this)">
                <span class="tab-icon">&#10024;</span>
                <span class="tab-label">Discover</span>
            </button>
            <button class="tab-btn" onclick="switchTab('recommendations', this)">
                <span class="tab-icon">&#127919;</span>
                <span class="tab-label">For You</span>
            </button>
            <button class="tab-btn" onclick="switchTab('library', this)">
                <span class="tab-icon">&#128218;</span>
                <span class="tab-label">Library</span>
            </button>
            <button class="tab-btn" onclick="switchTab('comments', this)">
                <span class="tab-icon">&#128172;</span>
                <span class="tab-label">Chat</span>
            </button>
            <button class="tab-btn" onclick="switchTab('profile', this)">
                <span class="tab-icon">&#128100;</span>
                <span class="tab-label">Profile</span>
            </button>
        </nav>
    </div>

    <!-- Fullscreen Verse -->
    <div class="fullscreen-verse" id="fullscreen" onclick="closeFullscreenOverlay(event)">
        <div class="fullscreen-text" id="fullscreenText"></div>
        <div class="fullscreen-actions">
            <button class="fullscreen-btn" onclick="event.stopPropagation(); toggleLike(); updateFullscreenButtons();">
                <span id="fsLikeIcon">&#9825;</span>
                <span>Like</span>
            </button>
            <button class="fullscreen-btn" onclick="event.stopPropagation(); toggleSave(); updateFullscreenButtons();">
                <span id="fsSaveIcon">&#128278;</span>
                <span>Save</span>
            </button>
            <button class="fullscreen-btn" onclick="event.stopPropagation(); copyVerse();">
                <span>&#128203;</span>
                <span>Copy</span>
            </button>
        </div>
        <div class="fullscreen-hint">Click background to close</div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" onclick="closeSettings(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="close-btn" onclick="closeSettings()">&#10005;</button>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Dark Mode</div>
                    <div class="setting-desc">Use dark color scheme</div>
                </div>
                <div class="toggle active" id="darkToggle" onclick="toggleTheme()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Font Size</div>
                </div>
                <div class="segment-control" id="fontSizeSegment">
                    <button class="segment-btn" onclick="setFontSize('small')">Small</button>
                    <button class="segment-btn active" onclick="setFontSize('medium')">Med</button>
                    <button class="segment-btn" onclick="setFontSize('large')">Large</button>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Animations</div>
                    <div class="setting-desc">Enable transition effects</div>
                </div>
                <div class="toggle active" id="animToggle" onclick="toggleAnimations()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Sound Effects</div>
                    <div class="setting-desc">Play sound on new verses</div>
                </div>
                <div class="toggle active" id="soundToggle" onclick="toggleSound()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Auto-Recommendations</div>
                    <div class="setting-desc">Generate recommendations automatically</div>
                </div>
                <div class="toggle active" id="autoRecToggle" onclick="toggleAutoRec()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Compact Mode</div>
                    <div class="setting-desc">Reduce padding for more content</div>
                </div>
                <div class="toggle" id="compactToggle" onclick="toggleCompact()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Notification Bell</div>
                    <div class="setting-desc">Show toast notifications</div>
                </div>
                <div class="toggle active" id="notificationToggle" onclick="toggleNotifications()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <!-- Extra Settings -->
            <div style="margin: 20px 0 10px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                <div style="font-size: 12px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;"> Extra Features</div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Particle Effects</div>
                    <div class="setting-desc">Floating particles in background</div>
                </div>
                <div class="toggle" id="particlesToggle" onclick="toggleParticles()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">High Contrast</div>
                    <div class="setting-desc">Stronger colors for accessibility</div>
                </div>
                <div class="toggle" id="contrastToggle" onclick="toggleHighContrast()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <!-- Text to Speech Settings -->
            <div style="margin: 20px 0 10px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                <div style="font-size: 12px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;"> Text to Speech</div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Auto-Speak Verses</div>
                    <div class="setting-desc">Automatically read verses aloud</div>
                </div>
                <div class="toggle" id="ttsToggle" onclick="toggleTTS()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Speech Speed</div>
                    <div class="setting-desc">How fast verses are read</div>
                </div>
                <select class="setting-select" id="ttsSpeedSelect" onchange="changeTTSSpeed(this.value)">
                    <option value="1">1x (Normal)</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="1.75">1.75x</option>
                    <option value="2">2x (Fast)</option>
                </select>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Test Speech</div>
                    <div class="setting-desc">Click to test TTS</div>
                </div>
                <button class="btn btn-primary" onclick="testTTS()" style="padding: 8px 16px; font-size: 13px;"> Test</button>
            </div>

            <!-- Admin Only Setting -->
            <div class="setting-item admin-only" id="adminIntervalSetting">
                <div>
                    <div class="setting-label" style="color: var(--danger);">Verse Refresh Interval (Admin)</div>
                    <div class="setting-desc">How often to fetch new verses</div>
                </div>
                <select class="setting-select" id="intervalSelect" onchange="changeInterval(this.value)">
                    <option value="30">30 seconds</option>
                    <option value="60" selected>1 minute</option>
                    <option value="120">2 minutes</option>
                    <option value="300">5 minutes</option>
                </select>
            </div>

            <!-- Admin Dashboard Link -->
            <div class="setting-item admin-only" id="adminDashboardLink">
                <div>
                    <div class="setting-label" style="color: var(--primary);"> Admin Dashboard</div>
                    <div class="setting-desc">Manage users, view stats, and more</div>
                </div>
                <a href="/admin/dashboard" class="btn btn-primary" style="text-decoration: none; padding: 8px 16px; font-size: 13px;">Open</a>
            </div>

            <button class="admin-panel-btn" id="adminPanelBtn" onclick="openAdminUnlock()">
                 Staff Access
            </button>
        </div>
    </div>

    <!-- Admin Unlock Modal -->
    <div class="modal admin-unlock-modal" id="adminUnlockModal" onclick="closeAdminUnlock(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title"> Staff Access</div>
                <button class="close-btn" onclick="closeAdminUnlock()">&#10005;</button>
            </div>
            
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Select your role and enter the access code</p>
            
            <!-- Role Selection -->
            <div class="role-selector">
                <div class="role-btn" data-role="host" onclick="selectRole('host')">
                    <span class="role-icon"></span>
                    <span class="role-name">Host</span>
                </div>
                <div class="role-btn" data-role="mod" onclick="selectRole('mod')">
                    <span class="role-icon"></span>
                    <span class="role-name">Mod</span>
                </div>
                <div class="role-btn" data-role="co_owner" onclick="selectRole('co_owner')">
                    <span class="role-icon"></span>
                    <span class="role-name">Co-Owner</span>
                </div>
                <div class="role-btn" data-role="owner" onclick="selectRole('owner')">
                    <span class="role-icon"></span>
                    <span class="role-name">Owner</span>
                </div>
            </div>
            
            <input type="password" class="admin-code-input" id="adminCodeInput" placeholder="Enter code for selected role..." maxlength="20">
            
            <button class="unlock-btn" id="unlockBtn" onclick="verifyRoleCode()" disabled>Access Panel</button>
            
            <div style="margin-top: 16px; padding: 12px; background: rgba(255,55,95,0.1); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                <strong style="color: var(--danger);">Need help?</strong> Contact administration for your access code.
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let currentVerse = null;
        let currentTab = 'discover';
        let libraryData = { liked: [], saved: [], collections: [] };
        let settings = {
            darkMode: true,
            fontSize: 'medium',
            animations: true,
            sound: true,
            autoRec: true,
            compact: false,
            notifications: true,
            interval: 60,
            particles: false,
            highContrast: false,
            ttsEnabled: false,
            ttsSpeed: 1
        };
        
        // Text to Speech
        const TTS = {
            synth: window.speechSynthesis,
            currentUtterance: null,
            
            speak(text, speed = 1) {
                if (!this.synth) {
                    console.error('TTS not supported');
                    return;
                }
                
                // Cancel any current speech
                this.synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = speed;
                utterance.pitch = 1;
                utterance.volume = 1;
                utterance.lang = 'en-US';
                
                // Try to find a good voice
                const voices = this.synth.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Google US English')) ||
                                      voices.find(v => v.name.includes('Samantha')) ||
                                      voices.find(v => v.lang === 'en-US' && v.name.includes('Female')) ||
                                      voices[0];
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                this.currentUtterance = utterance;
                this.synth.speak(utterance);
            },
            
            stop() {
                if (this.synth) {
                    this.synth.cancel();
                }
            },
            
            isSpeaking() {
                return this.synth ? this.synth.speaking : false;
            }
        };
        
        // Load voices when available
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                TTS.synth.getVoices();
            };
        }
        let autoRecInterval = null;
        let verseCheckInterval = null;
        let isAdmin = false;
        let favoritesCollection = null;

        // Permanent Timer State
        let sessionStartTime = null;
        let timerInterval = null;

        // Drag and Drop State
        let dragState = {
            isDragging: false,
            draggedVerse: null,
            dragTimer: null,
            startX: 0,
            startY: 0,
            hasMoved: false
        };

        // Initialize
        async function init() {
            loadSettings();
            initPermanentTimer();
            fetchVerse();
            verseCheckInterval = setInterval(fetchVerse, 1000);
            checkAdminStatus();
            
            // Setup textarea auto-resize
            setupTextarea('commentInput');
            setupTextarea('communityInput');
        }

        function setupTextarea(id) {
            const el = document.getElementById(id);
            if (!el) return;
            
            el.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            el.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (id === 'commentInput') postComment();
                    else if (id === 'communityInput') postCommunityMessage();
                }
            });
        }

        // Permanent Timer Functions
        function initPermanentTimer() {
            // Check if we have a stored start time
            const storedStart = localStorage.getItem('bibleAppStartTime');
            const storedIsAdmin = localStorage.getItem('bibleAppIsAdmin');
            
            if (storedStart) {
                sessionStartTime = parseInt(storedStart);
            } else {
                sessionStartTime = Date.now();
                localStorage.setItem('bibleAppStartTime', sessionStartTime);
            }
            
            if (storedIsAdmin === 'true') {
                isAdmin = true;
                updateAdminUI();
            }
            
            // Update every second
            updateTimeOnSite();
            timerInterval = setInterval(updateTimeOnSite, 1000);
        }

        function updateTimeOnSite() {
            const now = Date.now();
            const elapsed = Math.floor((now - sessionStartTime) / 1000); // in seconds
            
            const hours = Math.floor(elapsed / 3600);
            const mins = Math.floor((elapsed % 3600) / 60);
            const secs = elapsed % 60;
            
            let timeText = '';
            if (hours > 0) {
                timeText = `${hours}h ${mins}m ${secs}s`;
            } else if (mins > 0) {
                timeText = `${mins}m ${secs}s`;
            } else {
                timeText = `${secs}s`;
            }
            
            const el = document.getElementById('timeOnSite');
            if (el) el.textContent = timeText;
        }

        // Admin Functions
        let userRole = 'user';
        
        async function checkAdminStatus() {
            try {
                const res = await fetch('/api/user_info');
                const data = await res.json();
                userRole = data.role || 'user';
                
                if (data.is_admin || data.session_admin) {
                    isAdmin = true;
                    localStorage.setItem('bibleAppIsAdmin', 'true');
                    localStorage.setItem('bibleAppRole', userRole);
                    updateAdminUI();
                }
                
                // Always update role badge
                updateRoleBadge(userRole);
            } catch (e) {
                console.error('Admin check failed:', e);
            }
        }
        
        function updateRoleBadge(role) {
            const badge = document.getElementById('roleBadge');
            const adminBadge = document.getElementById('adminBadge');
            const roleTag = document.getElementById('roleTag');
            
            if (!badge) return;
            
            // Hide admin badge, show role badge instead
            adminBadge.style.display = 'none';
            
            const roleDisplay = role.replace('_', ' ').toUpperCase();
            badge.textContent = roleDisplay;
            badge.className = 'role-badge role-' + role + ' show';
            
            // Update profile tag
            if (roleTag) {
                roleTag.textContent = roleDisplay;
                roleTag.style.color = getRoleColor(role);
                roleTag.style.display = 'block';
            }
        }
        
        function getRoleColor(role) {
            const colors = {
                'user': '#666',
                'host': '#30D158',
                'mod': '#FF9F0A',
                'co_owner': '#BF5AF2',
                'owner': '#FF375F'
            };
            return colors[role] || '#666';
        }

        function updateAdminUI() {
            // Show role badge
            const storedRole = localStorage.getItem('bibleAppRole') || 'user';
            updateRoleBadge(storedRole);
            
            // Show admin-only settings
            document.getElementById('adminIntervalSetting').classList.add('show');
            document.getElementById('adminDashboardLink').classList.add('show');
            
            // Hide unlock button
            const unlockBtn = document.getElementById('adminPanelBtn');
            if (unlockBtn) unlockBtn.style.display = 'none';
            
            // Show delete buttons on existing comments
            document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.classList.add('show');
            });
        }

        let brandClickCount = 0;
        let brandClickTimer = null;
        let selectedRole = null;

        function handleBrandClick() {
            brandClickCount++;
            
            if (brandClickCount === 1) {
                brandClickTimer = setTimeout(() => {
                    brandClickCount = 0;
                }, 1000);
            }
            
            if (brandClickCount >= 3) {
                clearTimeout(brandClickTimer);
                brandClickCount = 0;
                openAdminUnlock();
            }
        }

        function selectRole(role) {
            selectedRole = role;
            
            // Update UI
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`.role-btn[data-role="${role}"]`).classList.add('selected');
            
            // Enable unlock button
            document.getElementById('unlockBtn').disabled = false;
            
            // Update placeholder
            const roleNames = {
                'host': 'Host',
                'mod': 'Moderator',
                'co_owner': 'Co-Owner',
                'owner': 'Owner'
            };
            document.getElementById('adminCodeInput').placeholder = `Enter ${roleNames[role]} code...`;
            document.getElementById('adminCodeInput').focus();
        }

        function openAdminUnlock() {
            if (isAdmin) return;
            selectedRole = null;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('unlockBtn').disabled = true;
            document.getElementById('adminCodeInput').placeholder = 'Enter code for selected role...';
            document.getElementById('adminCodeInput').value = '';
            document.getElementById('adminUnlockModal').classList.add('active');
        }

        function closeAdminUnlock(e) {
            if (!e || e.target.id === 'adminUnlockModal') {
                document.getElementById('adminUnlockModal').classList.remove('active');
                document.getElementById('adminCodeInput').value = '';
                selectedRole = null;
                document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('unlockBtn').disabled = true;
            }
        }

        async function verifyRoleCode() {
            const code = document.getElementById('adminCodeInput').value.trim();
            
            if (!selectedRole) {
                showToast('Please select a role first', 'error');
                return;
            }
            
            if (!code) {
                showToast('Please enter a code', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/verify_role_code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: code, role: selectedRole})
                });
                
                const data = await res.json();
                
                if (data.success) {
                    isAdmin = true;
                    userRole = data.role;
                    localStorage.setItem('bibleAppIsAdmin', 'true');
                    localStorage.setItem('bibleAppRole', data.role);
                    updateAdminUI();
                    closeAdminUnlock();
                    showToast(`Role unlocked: ${data.role_display}! `, 3000);
                    console.log('Role assigned:', data.role, data.role_display);
                } else {
                    showToast(data.error || 'Invalid code for selected role.', 'error', 5000);
                    document.getElementById('adminCodeInput').value = '';
                    document.getElementById('adminCodeInput').focus();
                }
            } catch (e) {
                showToast('Error verifying code', 'error');
            }
        }

        // Tab Switching
        function switchTab(tab, btn = null) {
            currentTab = tab;
            
            document.querySelectorAll('.tab-view').forEach(v => {
                v.classList.remove('active');
                v.classList.remove('desktop-active');
            });
            document.getElementById(tab).classList.add('active');
            
            if (window.innerWidth >= 1024) {
                document.getElementById(tab).classList.add('desktop-active');
            }
            
            if (btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active');
                if (n.dataset.tab === tab) n.classList.add('active');
            });
            
            if (tab === 'library') loadLibrary();
            if (tab === 'comments') {
                loadComments();
                loadCommunityMessages();
            }
            if (tab === 'profile') loadProfileStats();
            if (tab === 'recommendations') loadRecommendations();
        }

        // Verse Handling
        async function fetchVerse() {
            try {
                const res = await fetch('/api/current');
                const data = await res.json();
                
                if (data.verse) {
                    const isNew = currentVerse && data.verse.id !== currentVerse.id;
                    currentVerse = data.verse;
                    
                    document.getElementById('verseText').textContent = data.verse.text;
                    document.getElementById('verseRef').textContent = data.verse.ref;
                    document.getElementById('verseSource').textContent = data.verse.source;
                    document.getElementById('fullscreenText').textContent = `"${data.verse.text}"\n\n ${data.verse.ref}`;
                    document.getElementById('commentVerseRef').textContent = data.verse.ref;
                    
                    const pct = (data.countdown / data.interval) * 100;
                    document.getElementById('timerBar').style.width = pct + '%';
                    document.getElementById('timerText').textContent = data.countdown + 's';
                    
                    if (isNew) {
                        // Speak the new verse if TTS is enabled
                        speakVerse(data.verse.text, data.verse.ref);
                        
                        // Add to history
                        addToVerseHistory(data.verse);
                        
                        if (settings.notifications) {
                            showToast('New verse discovered!');
                        }
                        if (currentTab === 'comments') loadComments();
                    }
                    
                    checkStatus(data.verse.id);
                }
            } catch (e) {
                console.error('Fetch error:', e);
            }
        }

        async function checkStatus(verseId) {
            const [likeRes, saveRes] = await Promise.all([
                fetch(`/api/check_like/${verseId}`),
                fetch(`/api/check_save/${verseId}`)
            ]);
            const likeData = await likeRes.json();
            const saveData = await saveRes.json();
            
            updateLikeUI(likeData.liked);
            updateSaveUI(saveData.saved);
        }

        function updateLikeUI(liked) {
            const icon = document.getElementById('likeIcon');
            icon.innerHTML = liked ? '&#9829;' : '&#9825;';
            icon.style.color = liked ? 'var(--danger)' : '';
        }

        function updateSaveUI(saved) {
            const icon = document.getElementById('saveIcon');
            icon.innerHTML = saved ? '&#128209;' : '&#128278;';
            icon.style.color = saved ? 'var(--warning)' : '';
        }

        async function toggleLike() {
            if (!currentVerse) return;
            const res = await fetch('/api/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: currentVerse.id})
            });
            const data = await res.json();
            updateLikeUI(data.liked);
            if (settings.notifications) showToast(data.liked ? 'Added to likes' : 'Removed from likes');
            
            if (data.recommendation && settings.autoRec) {
                showRecommendation(data.recommendation);
            }
            if (currentTab === 'library') loadLibrary();
        }

        async function toggleSave() {
            if (!currentVerse) return;
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: currentVerse.id})
            });
            const data = await res.json();
            updateSaveUI(data.saved);
            if (settings.notifications) showToast(data.saved ? 'Verse saved' : 'Removed from saved');
            if (currentTab === 'library') loadLibrary();
        }

        // Copy & Share
        async function copyVerse() {
            if (!currentVerse) return;
            const text = `"${currentVerse.text}"  ${currentVerse.ref}`;
            await navigator.clipboard.writeText(text);
            if (settings.notifications) showToast('Copied to clipboard!');
        }

        async function shareVerse() {
            if (!currentVerse) return;
            const text = `"${currentVerse.text}"  ${currentVerse.ref}`;
            
            try {
                if (navigator.share) {
                    await navigator.share({ title: 'Bible AI Verse', text: text, url: window.location.href });
                    trackShare();
                } else {
                    await navigator.clipboard.writeText(text);
                    trackShare();
                    if (settings.notifications) showToast('Verse copied for sharing!');
                }
            } catch (e) {
                console.log('Share cancelled');
            }
        }

        // Fullscreen
        function toggleFullscreen(verse = null) {
            const fs = document.getElementById('fullscreen');
            const v = verse || currentVerse;
            
            if (v) {
                document.getElementById('fullscreenText').textContent = `"${v.text}"\n\n ${v.ref}`;
                updateFullscreenButtons(v.id);
                fs.classList.add('active');
            }
        }

        function closeFullscreenOverlay(e) {
            if (e.target.id === 'fullscreen') {
                document.getElementById('fullscreen').classList.remove('active');
            }
        }

        async function updateFullscreenButtons(verseId = null) {
            const id = verseId || (currentVerse ? currentVerse.id : null);
            if (!id) return;
            
            const [likeRes, saveRes] = await Promise.all([
                fetch(`/api/check_like/${id}`),
                fetch(`/api/check_save/${id}`)
            ]);
            const likeData = await likeRes.json();
            const saveData = await saveRes.json();
            
            document.getElementById('fsLikeIcon').innerHTML = likeData.liked ? '&#9829;' : '&#9825;';
            document.getElementById('fsSaveIcon').innerHTML = saveData.saved ? '&#128209;' : '&#128278;';
        }

        // Recommendations
        function setupAutoRecommendations() {
            if (autoRecInterval) clearInterval(autoRecInterval);
            autoRecInterval = setInterval(async () => {
                if (settings.autoRec && currentTab === 'recommendations') {
                    await generateRec(true);
                }
            }, 60000);
        }

        function toggleAutoRec() {
            settings.autoRec = !settings.autoRec;
            document.getElementById('autoRecToggle').classList.toggle('active');
            saveSettings();
            if (settings.notifications) showToast(settings.autoRec ? 'Auto-recommendations ON' : 'Auto-recommendations OFF');
        }

        async function loadRecommendations() {
            const res = await fetch('/api/recommendations');
            const data = await res.json();
            
            if (data.recommendations.length > 0) {
                displayRecommendations(data.recommendations);
            }
        }

        async function generateRec(silent = false) {
            const btn = document.querySelector('.gen-btn');
            btn.style.transform = 'scale(0.97)';
            setTimeout(() => btn.style.transform = '', 100);
            
            const res = await fetch('/api/generate-recommendation', {method: 'POST'});
            const data = await res.json();
            
            if (data.success) {
                showRecommendation(data.recommendation);
                if (!silent && settings.notifications) showToast('New recommendation!');
            }
        }

        function showRecommendation(rec) {
            const list = document.getElementById('recList');
            const card = createRecCard(rec);
            list.insertBefore(card, list.firstChild);
            
            while (list.children.length > 10) {
                list.removeChild(list.lastChild);
            }
        }

        function displayRecommendations(recs) {
            const list = document.getElementById('recList');
            list.innerHTML = '';
            recs.forEach(rec => {
                list.appendChild(createRecCard(rec));
            });
        }

        function createRecCard(rec) {
            const div = document.createElement('div');
            div.className = 'rec-card';
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--primary);">
                    <span>&#10024;</span>
                    <span>${rec.reason}</span>
                </div>
                <div style="font-size: 15px; line-height: 1.5; margin-bottom: 10px;">${rec.text}</div>
                <div style="font-size: 13px; opacity: 0.7; font-weight: 600; margin-bottom: 12px;">${rec.ref}</div>
                <div style="display: flex; gap: 8px;">
                    <button class="verse-card-btn" style="flex: 1;" onclick="recLike(${rec.id}, this)">&#9825; Like</button>
                    <button class="verse-card-btn" style="flex: 1;" onclick="recSave(${rec.id}, this)">&#128278; Save</button>
                </div>
            `;
            return div;
        }

        async function recLike(id, btn) {
            await fetch('/api/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: id})
            });
            btn.innerHTML = '&#9829; Liked';
            btn.classList.add('liked');
        }

        async function recSave(id, btn) {
            await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: id})
            });
            btn.innerHTML = '&#128209; Saved';
            btn.classList.add('saved');
        }

        // Library - Simplified with Favorites
        async function loadLibrary() {
            const res = await fetch('/api/library');
            libraryData = await res.json();
            
            // Find or create favorites collection
            favoritesCollection = libraryData.collections.find(c => c.name === 'Favorites');
            
            // Update favorites drop zone count
            const favCount = favoritesCollection ? favoritesCollection.verses.length : 0;
            document.getElementById('favoritesCount').textContent = favCount;
            
            // Render combined liked and saved verses
            renderLibraryVerses();
        }

        function renderLibraryVerses() {
            const list = document.getElementById('libraryVersesList');
            
            // Combine liked and saved, remove duplicates
            const allVerses = [...libraryData.liked, ...libraryData.saved];
            const seen = new Set();
            const uniqueVerses = allVerses.filter(v => {
                if (seen.has(v.id)) return false;
                seen.add(v.id);
                return true;
            });
            
            if (uniqueVerses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9825;</div>
                        <div class="empty-state-text">No verses yet. Start liking and saving!</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = uniqueVerses.map(v => `
                <div class="verse-card" 
                     draggable="true"
                     data-verse-id="${v.id}"
                     data-verse='${JSON.stringify(v).replace(/'/g, "&#39;")}'
                     onmousedown="handleMouseDown(event, this)"
                     onmouseup="handleMouseUp(event, this)"
                     onmouseleave="handleMouseLeave(event, this)"
                     ontouchstart="handleTouchStart(event, this)"
                     ontouchend="handleTouchEnd(event, this)"
                     ondragstart="handleDragStart(event, this)">
                    <div class="verse-card-text">${v.text}</div>
                    <div class="verse-card-ref">${v.ref}</div>
                    <div class="verse-card-actions">
                        <button class="verse-card-btn ${v.liked_at ? 'liked' : ''}" onclick="event.stopPropagation(); libraryLike(${v.id})">
                            ${v.liked_at ? '&#9829; Liked' : '&#9825; Like'}
                        </button>
                        <button class="verse-card-btn ${v.saved_at ? 'saved' : ''}" onclick="event.stopPropagation(); librarySave(${v.id})">
                            ${v.saved_at ? '&#128209; Saved' : '&#128278; Save'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Drag and Drop Handlers
        function handleMouseDown(e, el) {
            dragState.startX = e.clientX;
            dragState.startY = e.clientY;
            dragState.hasMoved = false;
            dragState.draggedVerse = JSON.parse(el.dataset.verse);
            
            dragState.dragTimer = setTimeout(() => {
                dragState.isDragging = true;
                el.classList.add('dragging');
            }, 300);
        }

        function handleMouseUp(e, el) {
            clearTimeout(dragState.dragTimer);
            
            const dx = Math.abs(e.clientX - dragState.startX);
            const dy = Math.abs(e.clientY - dragState.startY);
            
            if (!dragState.isDragging && dx < 5 && dy < 5) {
                const verse = JSON.parse(el.dataset.verse);
                toggleFullscreen(verse);
            }
            
            setTimeout(() => {
                dragState.isDragging = false;
                dragState.draggedVerse = null;
                el.classList.remove('dragging');
            }, 50);
        }

        function handleMouseLeave(e, el) {
            clearTimeout(dragState.dragTimer);
            if (!dragState.isDragging) {
                dragState.draggedVerse = null;
            }
        }

        function handleTouchStart(e, el) {
            const touch = e.touches[0];
            dragState.startX = touch.clientX;
            dragState.startY = touch.clientY;
            dragState.hasMoved = false;
            dragState.draggedVerse = JSON.parse(el.dataset.verse);
            
            dragState.dragTimer = setTimeout(() => {
                dragState.isDragging = true;
                el.classList.add('dragging');
            }, 400);
        }

        function handleTouchEnd(e, el) {
            clearTimeout(dragState.dragTimer);
            
            const touch = e.changedTouches[0];
            const dx = Math.abs(touch.clientX - dragState.startX);
            const dy = Math.abs(touch.clientY - dragState.startY);
            
            if (!dragState.isDragging && dx < 10 && dy < 10) {
                const verse = JSON.parse(el.dataset.verse);
                toggleFullscreen(verse);
            }
            
            setTimeout(() => {
                dragState.isDragging = false;
                dragState.draggedVerse = null;
                el.classList.remove('dragging');
            }, 50);
        }

        function handleDragStart(e, el) {
            if (!dragState.isDragging && dragState.draggedVerse) {
                dragState.isDragging = true;
                dragState.draggedVerse = JSON.parse(el.dataset.verse);
            }
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', el.dataset.verseId);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('favoritesDropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            document.getElementById('favoritesDropZone').classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            document.getElementById('favoritesDropZone').classList.remove('drag-over');
            
            const verseId = dragState.draggedVerse ? dragState.draggedVerse.id : parseInt(e.dataTransfer.getData('text/plain'));
            if (!verseId) return;
            
            // Create favorites collection if doesn't exist, then add verse
            try {
                let collectionId = favoritesCollection ? favoritesCollection.id : null;
                
                if (!collectionId) {
                    // Create favorites collection
                    const createRes = await fetch('/api/collections/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name: 'Favorites', color: '#FF375F'})
                    });
                    const createData = await createRes.json();
                    collectionId = createData.id;
                    favoritesCollection = createData;
                }
                
                const res = await fetch('/api/collections/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({collection_id: collectionId, verse_id: verseId})
                });
                
                const data = await res.json();
                if (data.success) {
                    if (settings.notifications) showToast('Added to Favorites!');
                    loadLibrary();
                } else {
                    if (settings.notifications) showToast('Already in Favorites');
                }
            } catch (e) {
                console.error('Drop error:', e);
            }
            
            dragState.isDragging = false;
            dragState.draggedVerse = null;
            document.querySelectorAll('.verse-card.dragging').forEach(el => el.classList.remove('dragging'));
        }

        async function libraryLike(id) {
            await fetch('/api/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: id})
            });
            loadLibrary();
            if (currentVerse && currentVerse.id === id) checkStatus(id);
        }

        async function librarySave(id) {
            await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: id})
            });
            loadLibrary();
            if (currentVerse && currentVerse.id === id) checkStatus(id);
        }

        // Comments
        async function loadComments() {
            if (!currentVerse) return;
            const res = await fetch(`/api/comments/${currentVerse.id}`);
            const comments = await res.json();
            
            const list = document.getElementById('commentsList');
            if (comments.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">No comments yet. Share your thoughts!</div></div>';
            } else {
                list.innerHTML = comments.map(c => renderCommentItem(c, 'comment')).join('');
            }
            
            // Show delete buttons if admin
            if (isAdmin) {
                document.querySelectorAll('.delete-comment-btn').forEach(btn => btn.classList.add('show'));
            }
        }

        async function postComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if (!text || !currentVerse) return;
            
            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: currentVerse.id, text: text})
            });
            
            if (res.ok) {
                input.value = '';
                input.style.height = 'auto';
                loadComments();
                loadProfileStats();
                if (settings.notifications) showToast('Comment posted!');
            }
        }

        // Community Chat
        async function loadCommunityMessages() {
            const res = await fetch('/api/community');
            const messages = await res.json();
            
            const list = document.getElementById('communityList');
            if (messages.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">Start a conversation about life, faith, or support!</div></div>';
            } else {
                list.innerHTML = messages.map(m => renderCommentItem(m, 'community')).join('');
            }
            
            if (isAdmin) {
                document.querySelectorAll('.delete-comment-btn').forEach(btn => btn.classList.add('show'));
            }
        }

        async function postCommunityMessage() {
            const input = document.getElementById('communityInput');
            const text = input.value.trim();
            if (!text) return;
            
            const res = await fetch('/api/community', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            });
            
            if (res.ok) {
                input.value = '';
                input.style.height = 'auto';
                loadCommunityMessages();
                if (settings.notifications) showToast('Message posted!');
            }
        }

        function renderCommentItem(c, type) {
            const isOwner = c.user_id === parseInt('{{ user.id }}');
            return `
                <div class="comment-item" id="${type}-${c.id}">
                    <button class="delete-comment-btn" onclick="deleteComment(${c.id}, '${type}')" title="Delete (Admin only)">&#10005;</button>
                    <div class="comment-header">
                        <img src="${c.user_picture}" class="comment-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(c.user_name)}&background=random'">
                        <div class="comment-meta">
                            <div class="comment-name">${c.user_name}</div>
                            <div class="comment-time">${new Date(c.timestamp).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="comment-text">${escapeHtml(c.text)}</div>
                </div>
            `;
        }

        async function deleteComment(id, type) {
            if (!isAdmin) return;
            
            if (!confirm('Delete this ' + (type === 'comment' ? 'comment' : 'message') + '?')) return;
            
            try {
                const endpoint = type === 'comment' ? `/api/admin/delete_comment/${id}` : `/api/admin/delete_community/${id}`;
                const res = await fetch(endpoint, {method: 'DELETE'});
                
                if (res.ok) {
                    document.getElementById(`${type}-${id}`).remove();
                    showToast('Deleted successfully');
                    loadProfileStats();
                }
            } catch (e) {
                showToast('Failed to delete');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Profile Stats
        async function loadProfileStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('statVerses').textContent = data.total_verses;
            document.getElementById('statLiked').textContent = data.liked;
            document.getElementById('statSaved').textContent = data.saved;
            document.getElementById('statComments').textContent = data.comments;
            
            const userRes = await fetch('/api/user_info');
            const userData = await userRes.json();
            
            if (userData.created_at) {
                const date = new Date(userData.created_at);
                document.getElementById('memberSince').textContent = date.toLocaleDateString();
            }
            
            // Load new profile features
            loadStreak();
            loadAchievements(data);
            loadFavoriteBooks();
            loadVerseHistory();
        }

        // === PROFILE ADD-ONS ===

        // 1. READING STREAK
        function loadStreak() {
            const streakData = JSON.parse(localStorage.getItem('verseStreak') || '{}');
            const today = new Date().toDateString();
            const lastVisit = streakData.lastVisit;
            let streak = streakData.streak || 0;
            
            // Check if this is a new day
            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastVisit === yesterday.toDateString()) {
                    streak++;
                } else if (lastVisit !== today) {
                    streak = 1;
                }
                
                streakData.streak = streak;
                streakData.lastVisit = today;
                localStorage.setItem('verseStreak', JSON.stringify(streakData));
            }
            
            // Update UI
            document.getElementById('streakBadge').textContent = streak + (streak === 1 ? ' DAY' : ' DAYS');
            
            const messages = [
                "Start your streak today! ",
                "Keep it going! You're on fire! ",
                "3 days! Building a habit! ",
                "4 days! Consistency is key! ",
                "5 days! Halfway to a week! ",
                "6 days! Almost there! ",
                "1 WEEK! Incredible dedication! ",
                "Over a week! You're unstoppable! "
            ];
            document.getElementById('streakMessage').textContent = 
                messages[Math.min(streak - 1, messages.length - 1)] || `${streak} days! Amazing discipline! `;
            
            // Generate calendar (last 14 days)
            const calendar = document.getElementById('streakCalendar');
            calendar.innerHTML = '';
            
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayStr = d.toDateString();
                
                const dayEl = document.createElement('div');
                dayEl.className = 'streak-day';
                dayEl.textContent = ['S','M','T','W','T','F','S'][d.getDay()];
                
                if (i === 0) {
                    dayEl.classList.add('today', 'active');
                } else if (i < streak && streakData.lastVisit === today) {
                    dayEl.classList.add('active');
                } else {
                    dayEl.classList.add('inactive');
                }
                
                calendar.appendChild(dayEl);
            }
        }

        // 2. ACHIEVEMENT BADGES
        const ACHIEVEMENTS = [
            { id: 'first_like', icon: '', name: 'First Love', desc: 'Like your first verse', check: (d) => d.liked >= 1 },
            { id: 'collector', icon: '', name: 'Collector', desc: 'Save 5 verses', check: (d) => d.saved >= 5 },
            { id: 'librarian', icon: '', name: 'Librarian', desc: 'Save 20 verses', check: (d) => d.saved >= 20 },
            { id: 'first_comment', icon: '', name: 'Voice', desc: 'Post a comment', check: (d) => d.comments >= 1 },
            { id: 'conversationalist', icon: '', name: 'Chatty', desc: 'Post 10 comments', check: (d) => d.comments >= 10 },
            { id: 'explorer', icon: '', name: 'Explorer', desc: 'View 50 verses', check: (d) => d.total_verses >= 50 },
            { id: 'scholar', icon: '', name: 'Scholar', desc: 'View 200 verses', check: (d) => d.total_verses >= 200 },
            { id: 'three_day_streak', icon: '', name: 'On Fire', desc: '3 day streak', check: (d) => {
                const s = JSON.parse(localStorage.getItem('verseStreak') || '{}');
                return (s.streak || 0) >= 3;
            }},
            { id: 'week_warrior', icon: '', name: 'Warrior', desc: '7 day streak', check: (d) => {
                const s = JSON.parse(localStorage.getItem('verseStreak') || '{}');
                return (s.streak || 0) >= 7;
            }},
            { id: 'night_owl', icon: '', name: 'Night Owl', desc: 'Visit after midnight', check: () => new Date().getHours() < 6 || new Date().getHours() > 22 },
            { id: 'early_bird', icon: '', name: 'Early Bird', desc: 'Visit before 8am', check: () => new Date().getHours() < 8 && new Date().getHours() >= 5 },
            { id: 'share_the_word', icon: '', name: 'Evangelist', desc: 'Share a verse', check: () => (localStorage.getItem('sharedVerses') || '').split(',').length >= 1 }
        ];

        function loadAchievements(stats) {
            const unlocked = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
            const grid = document.getElementById('achievementGrid');
            grid.innerHTML = '';
            
            // Check for new unlocks
            ACHIEVEMENTS.forEach(ach => {
                if (!unlocked.includes(ach.id) && ach.check(stats)) {
                    unlocked.push(ach.id);
                    if (settings.notifications) showToast(` Unlocked: ${ach.name}!`);
                }
            });
            localStorage.setItem('unlockedAchievements', JSON.stringify(unlocked));
            
            // Create tooltip element
            let tooltip = document.getElementById('achievementTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'achievementTooltip';
                tooltip.className = 'achievement-tooltip';
                document.body.appendChild(tooltip);
            }
            
            ACHIEVEMENTS.forEach(ach => {
                const isUnlocked = unlocked.includes(ach.id);
                const badge = document.createElement('div');
                badge.className = `achievement-badge ${isUnlocked ? 'unlocked' : 'locked'}`;
                badge.innerHTML = `
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-name">${ach.name}</div>
                `;
                
                // Tooltip events
                badge.addEventListener('mouseenter', (e) => {
                    tooltip.textContent = `${ach.name}: ${ach.desc}${isUnlocked ? ' ' : ' (Locked)'}`;
                    const rect = badge.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width/2) + 'px';
                    tooltip.style.top = (rect.top - 30) + 'px';
                    tooltip.style.transform = 'translateX(-50%)';
                    tooltip.classList.add('visible');
                });
                badge.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
                
                grid.appendChild(badge);
            });
        }

        // 3. FAVORITE BOOKS CHART
        async function loadFavoriteBooks() {
            const container = document.getElementById('favoriteBooksChart');
            container.innerHTML = '';
            
            try {
                // Get liked and saved verses
                const [likedRes, savedRes] = await Promise.all([
                    fetch('/api/liked_verses'),
                    fetch('/api/saved_verses')
                ]);
                const liked = await likedRes.json();
                const saved = await savedRes.json();
                
                // Count by book
                const bookCounts = {};
                [...liked, ...saved].forEach(v => {
                    const book = v.book || v.ref?.split(' ')[0] || 'Unknown';
                    bookCounts[book] = (bookCounts[book] || 0) + 1;
                });
                
                // Sort and get top 5
                const sorted = Object.entries(bookCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (sorted.length === 0) {
                    container.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Start liking verses to see your favorites!</div>';
                    return;
                }
                
                const maxCount = sorted[0][1];
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'];
                
                sorted.forEach(([book, count], i) => {
                    const bar = document.createElement('div');
                    bar.className = 'book-bar';
                    const pct = (count / maxCount) * 100;
                    bar.innerHTML = `
                        <div class="book-name">${book}</div>
                        <div class="book-progress">
                            <div class="book-fill" style="width: ${pct}%; background: linear-gradient(90deg, ${colors[i]}, ${colors[i]}88);">${pct > 30 ? count : ''}</div>
                        </div>
                        <div class="book-count">${count}</div>
                    `;
                    container.appendChild(bar);
                });
            } catch (e) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6;">Unable to load favorites</div>';
            }
        }

        // 4. VERSE HISTORY
        function loadVerseHistory() {
            const container = document.getElementById('verseHistory');
            const history = JSON.parse(localStorage.getItem('verseHistory') || '[]');
            const today = new Date().toDateString();
            
            // Filter to today's verses only
            const todayVerses = history.filter(v => new Date(v.timestamp).toDateString() === today);
            
            if (todayVerses.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Verses you see today will appear here!</div>';
                return;
            }
            
            container.innerHTML = '';
            todayVerses.slice().reverse().forEach(v => {
                const item = document.createElement('div');
                item.className = 'verse-history-item';
                const time = new Date(v.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                item.innerHTML = `
                    <div>
                        <div class="verse-history-ref">${v.ref}</div>
                    </div>
                    <div class="verse-history-time">${time}</div>
                `;
                container.appendChild(item);
            });
        }

        // Save verse to history when fetched
        function addToVerseHistory(verse) {
            if (!verse || !verse.ref) return;
            const history = JSON.parse(localStorage.getItem('verseHistory') || '[]');
            history.push({
                ref: verse.ref,
                id: verse.id,
                timestamp: Date.now()
            });
            // Keep last 100
            if (history.length > 100) history.shift();
            localStorage.setItem('verseHistory', JSON.stringify(history));
        }

        // Track shares for achievement
        function trackShare() {
            const shared = (localStorage.getItem('sharedVerses') || '').split(',').filter(x => x);
            shared.push(Date.now());
            localStorage.setItem('sharedVerses', shared.join(','));
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings(e) {
            if (!e || e.target.id === 'settingsModal') {
                document.getElementById('settingsModal').classList.remove('active');
            }
        }

        // ===== AUDIO SYSTEM =====
        const AudioSys = {
            ctx: null,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playTone(freq, type = 'sine', duration = 0.15, vol = 0.3) {
                if (!settings.sound) return;
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playSuccess() {
                this.playTone(523.25, 'sine', 0.1, 0.2); // C5
                setTimeout(() => this.playTone(659.25, 'sine', 0.2, 0.2), 100); // E5
            },
            playError() {
                this.playTone(200, 'sawtooth', 0.3, 0.2);
            },
            playClick() {
                this.playTone(800, 'sine', 0.05, 0.1);
            },
            playNotification() {
                this.playTone(880, 'sine', 0.1, 0.15);
                setTimeout(() => this.playTone(1100, 'sine', 0.2, 0.15), 100);
            }
        };

        function toggleTheme() {
            settings.darkMode = !settings.darkMode;
            document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light');
            document.getElementById('darkToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
        }

        function setFontSize(size) {
            settings.fontSize = size;
            // Apply font size scaling to html element
            const scales = {small: '0.875', medium: '1', large: '1.1875'};
            document.documentElement.style.fontSize = scales[size] + 'rem';
            
            // Update button states
            document.querySelectorAll('#fontSizeSegment .segment-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            AudioSys.playClick();
            saveSettings();
            showToast(`Font size: ${size}`);
        }

        function toggleAnimations() {
            settings.animations = !settings.animations;
            document.body.classList.toggle('no-animations', !settings.animations);
            document.getElementById('animToggle').classList.toggle('active');
            
            // Pause/resume ambient orbs
            document.querySelectorAll('.ambient-orb').forEach(orb => {
                orb.style.animationPlayState = settings.animations ? 'running' : 'paused';
            });
            
            AudioSys.playClick();
            saveSettings();
            showToast(settings.animations ? 'Animations ON' : 'Animations OFF');
        }

        function toggleSound() {
            settings.sound = !settings.sound;
            document.getElementById('soundToggle').classList.toggle('active');
            if (settings.sound) AudioSys.playSuccess();
            saveSettings();
            showToast(settings.sound ? 'Sound ON ' : 'Sound OFF ');
        }

        function toggleCompact() {
            settings.compact = !settings.compact;
            document.body.classList.toggle('compact-mode', settings.compact);
            document.getElementById('compactToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.compact ? 'Compact mode ON' : 'Compact mode OFF');
        }

        function toggleNotifications() {
            settings.notifications = !settings.notifications;
            document.getElementById('notificationToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.notifications ? 'Notifications ON ' : 'Notifications OFF ');
        }
        
        function toggleParticles() {
            settings.particles = !settings.particles;
            document.body.classList.toggle('particles-on', settings.particles);
            document.getElementById('particlesToggle').classList.toggle('active');
            
            if (settings.particles) {
                createParticles();
            } else {
                document.querySelectorAll('.particle').forEach(p => p.remove());
            }
            
            AudioSys.playClick();
            saveSettings();
            showToast(settings.particles ? 'Particles ON ' : 'Particles OFF');
        }
        
        function toggleHighContrast() {
            settings.highContrast = !settings.highContrast;
            document.body.classList.toggle('high-contrast', settings.highContrast);
            document.getElementById('contrastToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.highContrast ? 'High contrast ON' : 'High contrast OFF');
        }
        
        // Text to Speech Functions
        function toggleTTS() {
            settings.ttsEnabled = !settings.ttsEnabled;
            document.getElementById('ttsToggle').classList.toggle('active');
            
            if (!settings.ttsEnabled) {
                TTS.stop();
            }
            
            AudioSys.playClick();
            saveSettings();
            showToast(settings.ttsEnabled ? ' Auto-speak ON' : ' Auto-speak OFF');
        }
        
        function changeTTSSpeed(speed) {
            settings.ttsSpeed = parseFloat(speed);
            saveSettings();
            showToast(`Speech speed: ${speed}x`);
        }
        
        function testTTS() {
            const testText = "For God so loved the world, that he gave his only begotten Son.";
            TTS.speak(testText, settings.ttsSpeed);
            showToast(' Playing test...');
        }
        
        function speakVerse(verseText, verseRef) {
            if (settings.ttsEnabled && verseText) {
                const textToSpeak = `${verseText}. ${verseRef}.`;
                TTS.speak(textToSpeak, settings.ttsSpeed);
            }
        }

        async function changeInterval(val) {
            if (!isAdmin) {
                showToast('Admin access required');
                return;
            }
            
            settings.interval = parseInt(val);
            saveSettings();
            
            const res = await fetch('/api/set_interval', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({interval: settings.interval})
            });
            
            if (res.ok) {
                if (settings.notifications) showToast(`Interval set to ${val}s`);
            } else {
                showToast('Failed to update interval');
            }
        }

        function saveSettings() {
            localStorage.setItem('bibleSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            // Default settings with new options
            const defaults = {
                darkMode: true,
                fontSize: 'medium',
                animations: true,
                sound: true,
                autoRec: true,
                compact: false,
                notifications: true,
                interval: 60,
                particles: false,
                highContrast: false,
                reducedMotion: false,
                ttsEnabled: false,
                ttsSpeed: 1
            };
            
            const saved = localStorage.getItem('bibleSettings');
            if (saved) {
                settings = {...defaults, ...JSON.parse(saved)};
            } else {
                settings = defaults;
            }
            
            // Apply theme
            if (!settings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('darkToggle').classList.remove('active');
            }
            
            // Apply font size
            const scales = {small: '0.875', medium: '1', large: '1.1875'};
            document.documentElement.style.fontSize = scales[settings.fontSize] + 'rem';
            
            // Update font size button states
            const fontSizeMap = {small: 0, medium: 1, large: 2};
            const fontBtns = document.querySelectorAll('#fontSizeSegment .segment-btn');
            if (fontBtns[fontSizeMap[settings.fontSize]]) {
                fontBtns.forEach(b => b.classList.remove('active'));
                fontBtns[fontSizeMap[settings.fontSize]].classList.add('active');
            }
            
            // Apply animations
            if (!settings.animations) {
                document.body.classList.add('no-animations');
                document.getElementById('animToggle').classList.remove('active');
                document.querySelectorAll('.ambient-orb').forEach(orb => {
                    orb.style.animationPlayState = 'paused';
                });
            }
            
            // Apply sound
            if (!settings.sound) document.getElementById('soundToggle').classList.remove('active');
            
            // Apply auto recommendations
            if (!settings.autoRec) document.getElementById('autoRecToggle').classList.remove('active');
            
            // Apply compact mode
            if (settings.compact) {
                document.body.classList.add('compact-mode');
                document.getElementById('compactToggle').classList.add('active');
            }
            
            // Apply notifications
            if (!settings.notifications) document.getElementById('notificationToggle').classList.remove('active');
            
            // Apply particles
            if (settings.particles) {
                document.getElementById('particlesToggle').classList.add('active');
                createParticles();
            }
            
            // Apply high contrast
            if (settings.highContrast) {
                document.body.classList.add('high-contrast');
                document.getElementById('contrastToggle').classList.add('active');
            }
            
            // Apply TTS settings
            if (settings.ttsEnabled) {
                document.getElementById('ttsToggle').classList.add('active');
            }
            if (settings.ttsSpeed) {
                document.getElementById('ttsSpeedSelect').value = settings.ttsSpeed;
            }
            
            // Apply interval
            if (settings.interval) document.getElementById('intervalSelect').value = settings.interval;
            
            setupAutoRecommendations();
        }
        
        // Create floating particles
        function createParticles() {
            const container = document.querySelector('.particles');
            if (!container) return;
            
            container.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (10 + Math.random() * 20) + 's';
                p.style.animationDelay = Math.random() * 15 + 's';
                p.style.opacity = 0.2 + Math.random() * 0.3;
                container.appendChild(p);
            }
        }

        // Toast with sound
        function showToast(msg, type = 'info', duration = 2800) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast';
            toast.classList.add('show');
            
            // Play appropriate sound
            if (settings.sound) {
                if (type === 'success' || msg.includes('success') || msg.includes('') || msg.includes('ON')) {
                    AudioSys.playSuccess();
                } else if (type === 'error' || msg.includes('error') || msg.includes('') || msg.includes('OFF')) {
                    AudioSys.playError();
                } else {
                    AudioSys.playNotification();
                }
            }
            
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function logout() {
            // Clear timer on logout
            localStorage.removeItem('bibleAppStartTime');
            localStorage.removeItem('bibleAppIsAdmin');
            window.location.href = '/logout';
        }

        function showUser() {
            switchTab('profile');
        }

        // Responsive handler
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                document.querySelectorAll('.tab-view.active').forEach(el => el.classList.add('desktop-active'));
            } else {
                document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('desktop-active'));
            }
        });

        // Start
        init();
    </script>
</body>
</html>


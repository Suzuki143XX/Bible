{% extends "admin_base.html" %}

{% block title %}Dashboard{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">üë•</div>
        <div class="stat-value" id="statTotalUsers">{{ stats.total_users or 0 }}</div>
        <div class="stat-label">Total Users</div>
        <div class="stat-change positive">
            <span>‚Üë</span>
            <span>{{ stats.new_users_week or 0 }} this week</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon purple">üëë</div>
        <div class="stat-value" id="statAdminUsers">{{ stats.admin_users or 0 }}</div>
        <div class="stat-label">Administrators</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon red">üö´</div>
        <div class="stat-value" id="statBannedUsers">{{ stats.banned_users or 0 }}</div>
        <div class="stat-label">Banned Users</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon green">üìñ</div>
        <div class="stat-value" id="statTotalVerses">{{ stats.total_verses or 0 }}</div>
        <div class="stat-label">Total Verses</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon orange">‚ù§Ô∏è</div>
        <div class="stat-value" id="statTotalLikes">{{ stats.total_likes or 0 }}</div>
        <div class="stat-label">Total Likes</div>
    </div>

    <div class="stat-card">
        <div class="stat-icon blue">üí¨</div>
        <div class="stat-value" id="statTotalComments">{{ stats.total_comments or 0 }}</div>
        <div class="stat-label">Comments</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <div class="card-title">‚ö° Quick Actions</div>
    </div>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <a href="/admin/users" class="btn btn-primary">
            <span>üë•</span>
            Manage Users
        </a>
        <a href="/admin/audits" class="btn btn-secondary">
            <span>üìã</span>
            View Audit Logs
        </a>
        <button class="btn btn-secondary" onclick="refreshStats()">
            <span>üîÑ</span>
            Refresh Stats
        </button>
        <button class="btn btn-danger" onclick="openQuickBanModal()">
            <span>üö´</span>
            Quick Ban User
        </button>
    </div>
</div>

<!-- Quick Ban Modal -->
<div class="modal-overlay" id="quickBanModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">üö´ Quick Ban User</div>
            <button class="modal-close" onclick="closeQuickBanModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Search User</label>
                <input type="text" class="form-input" id="quickBanSearch" placeholder="Type user name or email..." onkeyup="searchUsersForBan()">
                <div id="quickBanResults" style="margin-top: 8px; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="form-group" id="banDetailsSection" style="display: none;">
                <label class="form-label">Selected User</label>
                <div id="selectedBanUser" style="background: var(--surface); padding: 12px; border-radius: 8px; margin-bottom: 12px;"></div>
                <label class="form-label">Ban Reason</label>
                <textarea class="form-input" id="quickBanReason" rows="2" placeholder="Enter reason..."></textarea>
                <label class="form-label" style="margin-top: 12px;">Duration</label>
                <select class="form-select" id="quickBanDuration">
                    <option value="">Permanent</option>
                    <option value="1">1 Hour</option>
                    <option value="24">1 Day</option>
                    <option value="168">1 Week</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeQuickBanModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmQuickBanBtn" onclick="confirmQuickBan()" disabled>Ban User</button>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card">
    <div class="card-header">
        <div class="card-title">üìã Recent Admin Activity</div>
        <a href="/admin/audits" class="btn btn-sm btn-secondary">View All</a>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Admin</th>
                    <th>Action</th>
                    <th>Target</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody id="activityTableBody">
                {% if recent_activity %}
                    {% for activity in recent_activity %}
                    <tr>
                        <td>{{ activity.admin_name }}</td>
                        <td>
                            <span class="badge {% if activity.action == 'user_banned' %}badge-danger{% elif activity.action == 'user_updated' %}badge-warning{% else %}badge-primary{% endif %}">
                                {{ activity.action.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>{{ activity.target_name or '-' }}</td>
                        <td>{{ activity.created_at }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-title">No activity yet</div>
                            <div style="color: var(--text-tertiary);">Admin actions will appear here</div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- System Status -->
<div class="card">
    <div class="card-header">
        <div class="card-title">üñ•Ô∏è System Status</div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
            <div>
                <div style="font-weight: 600;">Generator</div>
                <div style="font-size: 13px; color: var(--text-tertiary);">Running</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
            <div>
                <div style="font-weight: 600;">Database</div>
                <div style="font-size: 13px; color: var(--text-tertiary);">Connected</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
            <div>
                <div style="font-weight: 600;">Authentication</div>
                <div style="font-size: 13px; color: var(--text-tertiary);">Active</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></div>
            <div>
                <div style="font-weight: 600;">API</div>
                <div style="font-size: 13px; color: var(--text-tertiary);">Online</div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .user-search-result {
        padding: 12px;
        background: var(--surface);
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .user-search-result:hover {
        background: var(--primary);
        color: white;
    }
    
    .user-search-result.selected {
        background: var(--primary);
        color: white;
        box-shadow: 0 0 0 2px var(--primary-glow);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let selectedBanUserId = null;
    let selectedBanUserName = '';
    let banSearchTimeout = null;

    // Refresh stats from API
    async function refreshStats() {
        try {
            const response = await fetch('/admin/api/stats');
            const data = await response.json();
            
            if (data.error) {
                showToast('Error refreshing stats: ' + data.error, 'error');
                return;
            }
            
            // Update stats
            document.getElementById('statTotalUsers').textContent = data.total_users || 0;
            document.getElementById('statAdminUsers').textContent = data.admin_users || 0;
            document.getElementById('statBannedUsers').textContent = data.banned_users || 0;
            document.getElementById('statTotalVerses').textContent = data.total_verses || 0;
            document.getElementById('statTotalLikes').textContent = data.total_likes || 0;
            document.getElementById('statTotalComments').textContent = data.total_comments || 0;
            
            showToast('Stats refreshed successfully');
        } catch (e) {
            showToast('Error refreshing stats', 'error');
        }
    }

    // Quick Ban Modal
    function openQuickBanModal() {
        document.getElementById('quickBanModal').classList.add('active');
        document.getElementById('quickBanSearch').value = '';
        document.getElementById('quickBanResults').innerHTML = '';
        document.getElementById('banDetailsSection').style.display = 'none';
        document.getElementById('confirmQuickBanBtn').disabled = true;
        selectedBanUserId = null;
        selectedBanUserName = '';
        setTimeout(() => document.getElementById('quickBanSearch').focus(), 100);
    }

    function closeQuickBanModal() {
        document.getElementById('quickBanModal').classList.remove('active');
        selectedBanUserId = null;
        selectedBanUserName = '';
    }

    async function searchUsersForBan() {
        const search = document.getElementById('quickBanSearch').value;
        
        if (search.length < 2) {
            document.getElementById('quickBanResults').innerHTML = '';
            return;
        }
        
        clearTimeout(banSearchTimeout);
        banSearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/admin/api/users?search=${encodeURIComponent(search)}&per_page=5`);
                const data = await response.json();
                
                if (data.users && data.users.length > 0) {
                    renderBanSearchResults(data.users);
                } else {
                    document.getElementById('quickBanResults').innerHTML = `
                        <div style="color: var(--text-tertiary); text-align: center; padding: 20px;">
                            No users found
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Error searching users:', e);
            }
        }, 300);
    }

    function renderBanSearchResults(users) {
        const container = document.getElementById('quickBanResults');
        
        container.innerHTML = users.map(user => `
            <div class="user-search-result" onclick="selectUserForBan(${user.id}, '${user.name}', '${user.email}', '${user.picture || ''}')">
                <img src="${user.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=0a84ff&color=fff`}" 
                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                <div>
                    <div style="font-weight: 600;">${user.name}</div>
                    <div style="font-size: 12px; opacity: 0.8;">${user.email}</div>
                    ${user.is_banned ? '<span style="font-size: 11px; color: var(--danger);">üî¥ Already banned</span>' : ''}
                </div>
            </div>
        `).join('');
    }

    function selectUserForBan(id, name, email, picture) {
        selectedBanUserId = id;
        selectedBanUserName = name;
        
        // Highlight selected
        document.querySelectorAll('.user-search-result').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        // Show ban details section
        document.getElementById('banDetailsSection').style.display = 'block';
        document.getElementById('confirmQuickBanBtn').disabled = false;
        
        // Display selected user
        document.getElementById('selectedBanUser').innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="${picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0a84ff&color=fff`}" 
                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                <div>
                    <div style="font-weight: 600;">${name}</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">${email}</div>
                </div>
            </div>
        `;
    }

    async function confirmQuickBan() {
        if (!selectedBanUserId) return;
        
        const reason = document.getElementById('quickBanReason').value || 'Violation of terms';
        const duration = document.getElementById('quickBanDuration').value;
        
        try {
            const response = await fetch(`/admin/api/user/${selectedBanUserId}/ban`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason, duration })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(`${selectedBanUserName} has been banned`);
                closeQuickBanModal();
                refreshStats(); // Refresh stats to show updated banned count
            } else {
                showToast(data.error || 'Error banning user', 'error');
            }
        } catch (e) {
            showToast('Error banning user', 'error');
        }
    }

    // Close modal on overlay click
    document.getElementById('quickBanModal').addEventListener('click', function(e) {
        if (e.target === this) closeQuickBanModal();
    });

    // Auto refresh stats every 30 seconds
    setInterval(refreshStats, 30000);
</script>
{% endblock %}
